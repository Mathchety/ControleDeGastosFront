@startuml Diagrama de Estados - Controle de Gastos App

skinparam state {
  BackgroundColor<<Auth>> LightBlue
  BackgroundColor<<Main>> LightGreen
  BackgroundColor<<Receipt>> LightYellow
  BackgroundColor<<Profile>> LightPink
  BackgroundColor<<Password>> LightCoral
}

[*] --> SplashScreen : App Inicia

state SplashScreen {
  [*] --> CheckingAuth : Verificando autenticação
  CheckingAuth --> HasToken : Token existe
  CheckingAuth --> NoToken : Sem token
}

SplashScreen --> AuthScreen : NoToken / Usuário não autenticado
SplashScreen --> HomeScreen : HasToken / Token válido

state "Autenticação" as AuthGroup <<Auth>> {
  state AuthScreen {
    [*] --> LoginForm : Exibindo Login
    LoginForm --> RegisterForm : Toggle para Registro
    RegisterForm --> LoginForm : Toggle para Login
    LoginForm --> AuthenticatingLogin : Submit Login
    RegisterForm --> AuthenticatingRegister : Submit Registro
  }
  
  state ForgotPasswordScreen {
    [*] --> EnteringEmail : Digite email
    EnteringEmail --> SendingResetLink : Enviar link
    SendingResetLink --> EmailSent : Sucesso
  }
  
  state ResetPasswordScreen {
    [*] --> EnteringNewPassword : Digite nova senha
    EnteringNewPassword --> ResettingPassword : Confirmar
    ResettingPassword --> PasswordReset : Sucesso
  }
}

AuthScreen --> ForgotPasswordScreen : "Esqueci minha senha"
ForgotPasswordScreen --> AuthScreen : Voltar / Email enviado
ResetPasswordScreen --> AuthScreen : Senha redefinida
AuthScreen --> HomeScreen : Login/Registro bem-sucedido

state "Área Principal" as MainArea <<Main>> {
  
  state "Tab Navigation" as TabNav {
    state HomeScreen {
      [*] --> LoadingData : Carregando dados
      LoadingData --> ShowingDashboard : Dados carregados
      ShowingDashboard --> RefreshingData : Pull to refresh
      RefreshingData --> ShowingDashboard : Atualizado
      ShowingDashboard --> ProcessingReceipt : Recibo em processamento
      ProcessingReceipt --> ShowingDashboard : Processamento completo
    }
    
    state CategoriesScreen {
      [*] --> LoadingCategories : Carregando categorias
      LoadingCategories --> ShowingCategories : Exibindo lista
      ShowingCategories --> RefreshingCategories : Pull to refresh
      RefreshingCategories --> ShowingCategories : Atualizado
    }
    
    state HistoryScreen {
      [*] --> LoadingHistory : Carregando histórico
      LoadingHistory --> ShowingHistory : Exibindo recibos
      ShowingHistory --> FilteringHistory : Aplicar filtros
      FilteringHistory --> ShowingHistory : Filtrado
      ShowingHistory --> RefreshingHistory : Pull to refresh
      RefreshingHistory --> ShowingHistory : Atualizado
    }
    
    state ProfileScreen {
      [*] --> ShowingProfile : Exibindo perfil
      ShowingProfile --> EditingProfile : Editar (em desenvolvimento)
    }
  }
  
  HomeScreen -[hidden]-> CategoriesScreen
  CategoriesScreen -[hidden]-> HistoryScreen
  HistoryScreen -[hidden]-> ProfileScreen
}

HomeScreen --> ScanScreen : Botão "Escanear"
HomeScreen --> ManualReceiptScreen : Botão "Criar Manual"
HomeScreen --> PreViewScreen : Clique em recibo
CategoriesScreen --> CategoryDetailsScreen : Clique em categoria
HistoryScreen --> PreViewScreen : Clique em recibo
ProfileScreen --> ChangePasswordScreen : "Alterar Senha"
ProfileScreen --> SettingsScreen : Configurações

state "Fluxo de Recibos" as ReceiptFlow <<Receipt>> {
  
  state ScanScreen {
    [*] --> ChoosingSource : Escolher fonte
    ChoosingSource --> ScanningQR : QR Code
    ChoosingSource --> TakingPhoto : Câmera
    ChoosingSource --> SelectingGallery : Galeria
    ScanningQR --> ProcessingQR : QR detectado
    TakingPhoto --> ProcessingPhoto : Foto capturada
    SelectingGallery --> ProcessingPhoto : Imagem selecionada
    ProcessingQR --> UploadingReceipt : Enviando para API
    ProcessingPhoto --> UploadingReceipt : Enviando para API
    UploadingReceipt --> ReceiptProcessing : Processamento iniciado
  }
  
  state ManualReceiptScreen {
    [*] --> EnteringReceiptInfo : Digite informações
    EnteringReceiptInfo --> AddingItems : Adicionar itens
    AddingItems --> EditingItem : Editar item
    EditingItem --> AddingItems : Item atualizado
    AddingItems --> ValidatingReceipt : Salvar recibo
    ValidatingReceipt --> ErrorValidation : Erro de validação
    ErrorValidation --> AddingItems : Corrigir erros
    ValidatingReceipt --> SavingReceipt : Validação OK
    SavingReceipt --> ReceiptSaved : Sucesso
  }
  
  state PreViewScreen {
    [*] --> LoadingReceiptDetails : Carregando detalhes
    LoadingReceiptDetails --> ShowingReceiptDetails : Exibindo recibo
    ShowingReceiptDetails --> EditingReceiptMode : Modo edição
    EditingReceiptMode --> EditingReceiptItem : Editar item
    EditingReceiptItem --> EditingReceiptMode : Item salvo
    EditingReceiptMode --> SavingChanges : Salvar alterações
    SavingChanges --> ShowingReceiptDetails : Sucesso
    ShowingReceiptDetails --> DeletingReceipt : Excluir recibo
    DeletingReceipt --> ReceiptDeleted : Confirmado
  }
  
  state CategoryDetailsScreen {
    [*] --> LoadingCategoryDetails : Carregando
    LoadingCategoryDetails --> ShowingCategoryDetails : Exibindo itens
    ShowingCategoryDetails --> EditingCategoryItem : Editar item
    EditingCategoryItem --> SavingItemChanges : Salvar
    SavingItemChanges --> ShowingCategoryDetails : Atualizado
    ShowingCategoryDetails --> DeletingCategoryItem : Excluir item
    DeletingCategoryItem --> ShowingCategoryDetails : Item excluído
  }
}

ScanScreen --> HomeScreen : Voltar / Recibo enviado
ManualReceiptScreen --> HomeScreen : Voltar / Recibo criado
PreViewScreen --> HomeScreen : Voltar
PreViewScreen --> HistoryScreen : Voltar do histórico
CategoryDetailsScreen --> CategoriesScreen : Voltar

state "Configurações de Perfil" as ProfileSettings <<Profile>> {
  
  state ChangePasswordScreen {
    [*] --> EnteringPasswords : Digite senhas
    EnteringPasswords --> ValidatingPasswords : Validar
    ValidatingPasswords --> ErrorPasswordValidation : Erro
    ErrorPasswordValidation --> EnteringPasswords : Corrigir
    ValidatingPasswords --> ChangingPassword : Validação OK
    ChangingPassword --> PasswordChanged : Sucesso
  }
  
  state SettingsScreen {
    [*] --> ShowingSettings : Exibindo opções
    ShowingSettings --> ChangingPreferences : Alterar preferências
    ChangingPreferences --> ShowingSettings : Salvo
  }
}

ChangePasswordScreen --> ProfileScreen : Voltar / Senha alterada
SettingsScreen --> ProfileScreen : Voltar

state "Logout" as LogoutState {
  [*] --> ConfirmingLogout : Confirmar logout
  ConfirmingLogout --> ClearingSession : Confirmado
  ClearingSession --> SessionCleared : Token removido
}

ProfileScreen --> LogoutState : Botão Logout
LogoutState --> AuthScreen : Sessão encerrada

note right of SplashScreen
  Estado inicial do app
  Valida token e redireciona
end note

note right of HomeScreen
  Dashboard principal
  Mostra resumo financeiro
  Recibos recentes
end note

note right of ScanScreen
  3 opções de captura:
  - QR Code (NFC-e)
  - Foto da câmera
  - Imagem da galeria
end note

note right of ManualReceiptScreen
  Criação manual de recibos
  Validação de campos
  Limites: 999.999 qtd
  999.999.999 valor
end note

note right of PreViewScreen
  Visualização detalhada
  Modo edição inline
  Exclusão de recibos
end note

note bottom of TabNav
  Bottom Tab Navigation
  4 tabs principais:
  Home | Categorias | Histórico | Perfil
end note

@enduml
